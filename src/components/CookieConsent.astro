---
import 'vanilla-cookieconsent/dist/cookieconsent.css';
import '../styles/ccElegantBlack.css';
---
<button type="button" data-cc="show-preferencesModal">Show preferences modal</button>

<script lang="ts">
  import * as CC from 'vanilla-cookieconsent';
  import { config } from './CookieConsentConfig';
  import { initGA, grantAnalyticsConsent } from '../ga.ts';

  // Theme-Klasse
  document.body.classList.add('cc--elegant-black');

  // Cross-compat: hol das CookieConsent-Objekt, egal wie exportiert
  const CookieConsent: any =
    (CC as any).CookieConsent ?? // Named export
    (CC as any).default ??       // (falls es doch einen default gäbe)
    CC;                          // Namespace selbst

  // HINWEIS: Wenn du "inline" nicht nutzt, stelle sicher, dass das Layout NICHT "inline" ist
  // (sonst brauchst du <div data-cc="consent-modal"></div>).
  CookieConsent.run({
    ...config,
    guiOptions: {
      ...config.guiOptions,
      consentModal: {
        ...config.guiOptions?.consentModal,
        // falls du keinen Inline-Platzhalter eingebaut hast, nimm "cloud" statt "cloud inline"
        layout: 'cloud',
      },
    },
  });

  // Bereits erteilte Zustimmung respektieren (nur in Prod)
  if (import.meta.env.PROD) {
    const prefs = CookieConsent.getUserPreferences?.() || {};
    const acceptedCats = prefs.acceptedCategories || [];
    const acceptedServices = Object.values(prefs.acceptedServices || {}).flat();

    const analyticsAllowed =
      acceptedCats.includes('analytics') || acceptedServices.includes('ga4');

    if (analyticsAllowed) {
      const MEASUREMENT_ID = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
      initGA(MEASUREMENT_ID);
      grantAnalyticsConsent();
      window.gtag?.('event', 'page_view', {
        page_location: location.href,
        page_path: location.pathname,
        page_title: document.title,
      });
    }
  }

  // Debug-Helfer (temporär):
  // (window as any).ccShow = () => CookieConsent.show(true);
  // (window as any).ccReset = () => CookieConsent.reset(true);
  // console.log('[CC] exports:', Object.keys(CC));
</script>
